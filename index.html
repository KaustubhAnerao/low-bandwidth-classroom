<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Low-Bandwidth Classroom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body { font-family: "Inter", sans-serif; background-color: #0f172a; color: #e2e8f0; }
      .container { max-width: 900px; margin: auto; padding: 1.5rem; }
      .slide-display { background-color: #1e293b; border-radius: 0.75rem; min-height: 400px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; font-weight: bold; transition: all 0.3s ease; overflow: hidden; }
      .slide-display img { max-width: 100%; max-height: 400px; height: auto; object-fit: contain; border-radius: 0.5rem; }
    </style>
  </head>
  <body class="p-4 sm-p-8">
    <div class="container bg-slate-800 rounded-2xl shadow-xl">
      <header class="text-center mb-6">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-white mb-2">Low-Bandwidth Classroom</h1>
        <p class="text-slate-400">WebSocket + PDF Conversion Prototype</p>
      </header>
      
      <div id="roleSelection" class="text-center">
         <h2 class="text-2xl font-bold mb-4">Choose Your Role</h2>
         <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-8">
            <button id="teacherRoleBtn" class="w-full sm:w-64 px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition-colors duration-200">I'm a Teacher</button>
            <button id="studentRoleBtn" class="w-full sm:w-64 px-8 py-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl transition-colors duration-200">I'm a Student</button>
         </div>
      </div>
      
      <div id="teacherDashboard" class="hidden">
         <div id="status" class="text-center mb-6 text-sm font-medium text-slate-400">Disconnected.</div>
         <form id="createSessionForm" class="p-4 bg-slate-900 rounded-xl mb-6">
            <h2 class="text-xl font-bold mb-4">Create New Session</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="sessionName" class="block text-sm font-medium text-slate-400 mb-1">Session Name</label>
                    <input type="text" id="sessionName" placeholder="e.g., AI Fundamentals" class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
                </div>
                <div>
                    <label for="sessionFile" class="block text-sm font-medium text-slate-400 mb-1">Upload Presentation (.pdf)</label>
                    <input type="file" id="sessionFile" accept=".pdf" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                </div>
                <div>
                    <label for="sessionDate" class="block text-sm font-medium text-slate-400 mb-1">Date</label>
                    <input type="date" id="sessionDate" class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
                </div>
                <div>
                    <label for="sessionTime" class="block text-sm font-medium text-slate-400 mb-1">Time</label>
                    <input type="time" id="sessionTime" class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
                </div>
            </div>
            <button type="button" id="createSessionBtn" class="w-full mt-4 px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg">Create & Schedule Session</button>
         </form>
         <div class="mb-4">
             <h2 class="text-2xl font-bold text-center">Scheduled Sessions</h2>
         </div>
         <div id="teacherSessionList" class="space-y-4"></div>
      </div>
      
      <!-- STUDENT DASHBOARD & VIEW -->
      <div id="studentDashboard" class="hidden">
          <p id="studentStatus" class="text-center mb-6 text-sm font-medium text-slate-400">Disconnected.</p>
          <div class="p-4 bg-slate-900 rounded-xl mb-6 flex justify-between items-center">
              <h2 class="text-xl font-bold">Available Sessions</h2>
              <button id="refreshSessionsBtn" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors duration-200">Refresh</button>
          </div>
          <div id="sessionList" class="space-y-4">
              <p id="noSessionsMessage" class="text-center text-slate-500">No sessions found. Click refresh to check.</p>
          </div>
      </div>

      <div id="studentView" class="hidden text-center">
          <h2 class="text-xl font-bold my-4">Live Session: <span id="studentCurrentSessionId" class="text-emerald-400"></span></h2>
          <div id="studentSlideDisplay" class="slide-display">
              <span>Waiting for teacher...</span>
          </div>
      </div>
      
    </div>

    <script>
      // --- DOM Elements ---
      const roleSelectionEl = document.getElementById("roleSelection");
      const teacherRoleBtn = document.getElementById("teacherRoleBtn");
      const studentRoleBtn = document.getElementById("studentRoleBtn");

      const teacherDashboardEl = document.getElementById("teacherDashboard");
      const statusEl = document.getElementById("status");
      const createSessionFormEl = document.getElementById("createSessionForm");
      const sessionNameInput = document.getElementById("sessionName");
      const sessionFileInput = document.getElementById("sessionFile");
      const sessionDateInput = document.getElementById("sessionDate");
      const sessionTimeInput = document.getElementById("sessionTime");
      const createSessionBtn = document.getElementById("createSessionBtn");
      const teacherSessionListEl = document.getElementById("teacherSessionList");

      const studentDashboardEl = document.getElementById("studentDashboard");
      const studentStatusEl = document.getElementById("studentStatus");
      const refreshSessionsBtn = document.getElementById("refreshSessionsBtn");
      const sessionListEl = document.getElementById("sessionList");
      const noSessionsMessageEl = document.getElementById("noSessionsMessage");
      const studentViewEl = document.getElementById("studentView");
      const studentSlideDisplayEl = document.getElementById("studentSlideDisplay");
      const studentCurrentSessionIdEl = document.getElementById("studentCurrentSessionId");

      let ws;
      let currentSessionIdForStudent = null;

      // --- IndexedDB Management for Local Slide Storage ---
      const dbManager = {
        db: null,
        init() {
            return new Promise((resolve, reject) => {
                if (this.db) return resolve();
                const request = indexedDB.open("slidesDB", 1);
                request.onerror = (event) => reject("IndexedDB error: " + event.target.errorCode);
                request.onsuccess = (event) => { this.db = event.target.result; resolve(); };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('slides')) {
                        db.createObjectStore('slides', { keyPath: 'id' });
                    }
                };
            });
        },
        async storeSlide(sessionId, slideNum, blob) {
            await this.init();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['slides'], 'readwrite');
                const request = transaction.objectStore('slides').put({ id: `${sessionId}-slide-${slideNum}`, image: blob });
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject('Failed to store slide: ' + event.target.error);
            });
        },
        async getSlide(sessionId, slideNum) {
            await this.init();
            return new Promise((resolve, reject) => {
                const request = this.db.transaction(['slides'], 'readonly').objectStore('slides').get(`${sessionId}-slide-${slideNum}`);
                request.onsuccess = (event) => {
                    if (event.target.result) resolve(event.target.result.image);
                    else reject('Slide not found in local storage.');
                };
                request.onerror = (event) => reject('Failed to get slide: ' + event.target.error);
            });
        },
        async isSessionDownloaded(sessionId, slideCount) {
             await this.init();
             if (slideCount === 0) return true;
             return new Promise((resolve) => {
                const request = this.db.transaction(['slides'], 'readonly').objectStore('slides').get(`${sessionId}-slide-${slideCount}`);
                request.onsuccess = (event) => resolve(!!event.target.result);
                request.onerror = () => resolve(false);
            });
        }
      };
      
      // --- UTILITY ---
      const generateSessionId = () => Math.random().toString(36).substring(2, 8).toUpperCase();
      
      // ✅ FIX: Created two separate functions for displaying slides.
      // This one is for TEACHERS - it loads directly from the server.
      const updateTeacherSlideDisplayFromServer = (el, slide, sessionId) => {
        if (!sessionId || slide < 1) {
            el.innerHTML = `<span>Waiting for content...</span>`;
            return;
        }
        const imageURL = `http://localhost:8080/slides/${sessionId}/slide-${slide}.png`;
        el.innerHTML = `<img src="${imageURL}" alt="Slide ${slide}" onerror="this.onerror=null;this.innerHTML='<span>Image Not Found</span>';">`;
      };
      
      // This one is for STUDENTS - it loads from local IndexedDB.
      const updateStudentSlideDisplayFromLocal = async (el, slide, sessionId, slideCount) => {
        if (!sessionId || slide < 1 || (slideCount && slide > slideCount)) {
            el.innerHTML = `<span>Waiting for content...</span>`;
            return;
        }
        try {
            const imageBlob = await dbManager.getSlide(sessionId, slide);
            const objectURL = URL.createObjectURL(imageBlob);
            if (el.dataset.previousUrl) URL.revokeObjectURL(el.dataset.previousUrl);
            el.innerHTML = `<img src="${objectURL}" alt="Slide ${slide}">`;
            el.dataset.previousUrl = objectURL;
        } catch (error) {
            console.error(error);
            el.innerHTML = `<span>Could not load slide from local storage.</span>`;
        }
      };
      
      // --- INITIAL ROLE SELECTION & CONNECTION ---
      teacherRoleBtn.addEventListener("click", () => {
          roleSelectionEl.classList.add("hidden");
          teacherDashboardEl.classList.remove("hidden");
          ws = new WebSocket("ws://localhost:8080");
          ws.onopen = () => { statusEl.textContent = "Connected to server."; statusEl.classList.add("text-green-400");};
          ws.onclose = () => { statusEl.textContent = "Disconnected."; statusEl.classList.remove("text-green-400");};
      });

      studentRoleBtn.addEventListener("click", () => {
          roleSelectionEl.classList.add("hidden");
          studentDashboardEl.classList.remove("hidden");
          studentStatusEl.textContent = "Click Refresh to see available sessions.";
          dbManager.init();
      });

      // --- TEACHER LOGIC ---
      createSessionBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        if (!ws || ws.readyState !== WebSocket.OPEN) { statusEl.textContent = "Not connected."; return; }
        const sessionName = sessionNameInput.value.trim();
        const sessionFile = sessionFileInput.files[0];
        const sessionDate = sessionDateInput.value;
        const sessionTime = sessionTimeInput.value;
        if (!sessionName || !sessionFile || !sessionDate || !sessionTime) { statusEl.textContent = "Please fill all fields and upload a PDF file."; return; }
        
        statusEl.textContent = "Uploading and processing PDF... Please wait.";
        const sessionId = generateSessionId();
        const formData = new FormData();
        formData.append("sessionFile", sessionFile);
        formData.append("sessionId", sessionId);

        try {
          const response = await fetch("http://localhost:8080/upload", { method: "POST", body: formData });
          const result = await response.json();
          if (!response.ok || !result.success) throw new Error(result.message || "File upload failed.");

          const { slideCount } = result;
          ws.send(JSON.stringify({
            action: "createSession", sessionId, sessionName, sessionDate, sessionTime,
            pptFileNames: [sessionFile.name], slideCount, role: "teacher"
          }));
          addSessionCardToTeacherList(sessionId, sessionName, [sessionFile.name], slideCount, sessionDate, sessionTime);
          createSessionFormEl.reset();
          statusEl.textContent = "Session created successfully!";
        } catch (error) { statusEl.textContent = `Error: ${error.message}`; }
      });

      const addSessionCardToTeacherList = (sessionId, name, files, slideCount, date, time) => {
        const card = document.createElement("div");
        card.className = "session-card bg-slate-900 rounded-xl p-6 shadow-md border border-indigo-500";
        card.dataset.sessionId = sessionId;
        card.dataset.sessionName = name;
        card.dataset.slideCount = slideCount;
        card.innerHTML = `
          <h3 class="text-xl font-bold mb-2 text-indigo-400">Session: ${name} (${sessionId})</h3>
          <p class="text-sm text-slate-400">Scheduled for: ${date} at ${time}</p>
          <p class="text-sm text-slate-400 mb-4">Files: ${files.join(', ')} (${slideCount} slides)</p>
          <button class="start-session-btn w-full mb-4 px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg">Start Session</button>
          <div class="teacher-view hidden text-center">
            <div class="slide-display"><span>Presentation will appear here.</span></div>
            <div class="mt-6 flex justify-center space-x-4">
              <button class="prev-btn px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">&larr; Prev</button>
              <button class="next-btn px-6 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg">Next &rarr;</button>
            </div>
          </div>`;
        teacherSessionListEl.appendChild(card);
      };

      teacherSessionListEl.addEventListener("click", (e) => {
        const card = e.target.closest(".session-card");
        if (!card) return;
        const sessionId = card.dataset.sessionId;
        const slideCount = parseInt(card.dataset.slideCount);
        let slide = parseInt(card.dataset.slide || "1");

        // ✅ FIX: Ensure teacher events call the correct display function.
        if (e.target.matches(".start-session-btn")) {
            ws.send(JSON.stringify({ action: "startSession", role: "teacher", sessionId }));
            e.target.classList.add("hidden");
            card.querySelector(".teacher-view").classList.remove("hidden");
            updateTeacherSlideDisplayFromServer(card.querySelector(".slide-display"), slide, sessionId);
        }
        
        const changeSlide = (newSlide) => {
            card.dataset.slide = newSlide;
            ws.send(JSON.stringify({ action: "slideChange", role: "teacher", sessionId, slide: newSlide }));
            updateTeacherSlideDisplayFromServer(card.querySelector(".slide-display"), newSlide, sessionId);
        };
        
        if (e.target.matches(".next-btn") && slide < slideCount) changeSlide(slide + 1);
        if (e.target.matches(".prev-btn") && slide > 1) changeSlide(slide - 1);
      });

      // --- STUDENT LOGIC with Pre-downloading ---
      refreshSessionsBtn.addEventListener("click", () => {
          const listWs = new WebSocket("ws://localhost:8080?role=getSessions");
          studentStatusEl.textContent = "Refreshing session list...";
          listWs.onmessage = (event) => {
              const message = JSON.parse(event.data);
              if (message.action === "sessionList") {
                  renderSessionCards(message.sessions);
                  studentStatusEl.textContent = "Session list updated.";
              }
          };
      });

      const renderSessionCards = (sessions) => {
          sessionListEl.innerHTML = "";
          const sessionEntries = Object.entries(sessions);
          if (sessionEntries.length === 0) { noSessionsMessageEl.classList.remove("hidden"); return; }
          noSessionsMessageEl.classList.add("hidden");
          sessionEntries.forEach(async ([sessionId, session]) => {
              const card = document.createElement("div");
              // ✅ FIX: Added the 'session-card' class to fix the download button bug.
              card.className = `session-card bg-slate-900 rounded-xl p-4 shadow-md border ${session.status === "live" ? "border-emerald-500" : "border-slate-600"} flex flex-col sm:flex-row items-start justify-between gap-4`;
              const isDownloaded = await dbManager.isSessionDownloaded(sessionId, session.slideCount);
              card.innerHTML = `
                <div class="flex-grow">
                    <h3 class="text-lg font-bold ${session.status === "live" ? "text-emerald-400" : "text-slate-200"}">${session.sessionName}</h3>
                    <p class="text-sm text-slate-400">ID: ${sessionId}</p>
                    <p class="text-sm text-slate-500 mt-2">Files: ${session.pptFileNames.join(', ')} (${session.slideCount} slides)</p>
                </div>
                <div class="flex flex-col items-end gap-2 w-full sm:w-auto">
                    <div class="w-full text-right h-4"><span class="download-status text-xs text-slate-400"></span></div>
                    <button class="download-btn w-full px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white font-bold rounded-lg ${isDownloaded ? 'hidden' : ''}" data-session-id="${sessionId}" data-slide-count="${session.slideCount}">Download Materials</button>
                    ${session.status === 'live'
                        ? `<button class="join-session-btn w-full px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg disabled:bg-slate-600 disabled:cursor-not-allowed" data-session-id="${sessionId}" ${!isDownloaded ? 'disabled' : ''}>Join Live Session</button>`
                        : `<div class="w-full px-4 py-2 bg-slate-700 text-slate-400 font-bold rounded-lg text-center">Scheduled ${isDownloaded ? '(Downloaded)' : ''}</div>`
                    }
                </div>`;
              sessionListEl.appendChild(card);
          });
      };

      sessionListEl.addEventListener('click', (e) => {
          if (e.target.matches('.download-btn')) {
              const button = e.target;
              downloadSession(button.dataset.sessionId, parseInt(button.dataset.slideCount), button);
          }
          if (e.target.matches('.join-session-btn')) {
              joinSession(e.target.dataset.sessionId);
          }
      });
      
      async function downloadSession(sessionId, slideCount, button) {
          const card = button.closest('.session-card');
          const statusEl = card.querySelector('.download-status');
          const joinBtn = card.querySelector('.join-session-btn');
          
          button.disabled = true;
          statusEl.textContent = 'Starting download...';
          let downloadedCount = 0;

          for (let i = 1; i <= slideCount; i++) {
              try {
                  const response = await fetch(`http://localhost:8080/slides/${sessionId}/slide-${i}.png`);
                  if (!response.ok) throw new Error(`Failed to fetch slide ${i}`);
                  const blob = await response.blob();
                  await dbManager.storeSlide(sessionId, i, blob);
                  downloadedCount++;
                  statusEl.textContent = `Downloading... (${downloadedCount}/${slideCount})`;
              } catch (error) {
                  statusEl.textContent = `Error: ${error.message}`;
                  button.disabled = false;
                  return;
              }
          }

          statusEl.textContent = 'Download Complete!';
          button.classList.add('hidden');
          if (joinBtn) joinBtn.disabled = false;
          const scheduledDiv = card.querySelector('.bg-slate-700');
          if (scheduledDiv) scheduledDiv.textContent = 'Scheduled (Downloaded)';
      }

      const joinSession = (sessionId) => {
        studentDashboardEl.classList.add("hidden");
        studentViewEl.classList.remove("hidden");
        studentCurrentSessionIdEl.textContent = sessionId;
        currentSessionIdForStudent = sessionId;
        if (ws && ws.readyState === WebSocket.OPEN) { ws.close(); }
        ws = new WebSocket(`ws://localhost:8080?sessionId=${sessionId}&role=student`);
        ws.onopen = () => ws.send(JSON.stringify({ action: "getInitialState" }));
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.action === "slideChange") {
                // ✅ FIX: Ensure student view calls the correct display function.
                updateStudentSlideDisplayFromLocal(studentSlideDisplayEl, msg.slide, currentSessionIdForStudent, msg.slideCount);
            }
        };
        ws.onclose = () => {
            studentDashboardEl.classList.remove("hidden");
            studentViewEl.classList.add("hidden");
            studentStatusEl.textContent = "Disconnected from session.";
        };
      };
    </script>
  </body>
</html>