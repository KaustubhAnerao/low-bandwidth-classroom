<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Low-Bandwidth Classroom</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <style>
      body { font-family: "Inter", sans-serif; background-color: #0f172a; color: #e2e8f0; }
      .container { max-width: 900px; margin: auto; padding: 1.5rem; }
      .slide-display { background-color: #1e293b; border-radius: 0.75rem; min-height: 400px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; font-weight: bold; transition: all 0.3s ease; overflow: hidden; position: relative; }
      .slide-display img { max-width: 100%; max-height: 400px; height: auto; object-fit: contain; border-radius: 0.5rem; }
      .wb-canvas { width: 100%; height: 100%; touch-action: none; border-radius: 0.5rem; background: transparent; position: absolute; top: 0; left: 0;}
    </style>
  </head>
  <body class="p-4 sm:p-8">
    <div class="container bg-slate-800 rounded-2xl shadow-xl">
      <header class="text-center mb-6">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-white mb-2">Low-Bandwidth Classroom</h1>
        <p class="text-slate-400">WebSocket + PDF Conversion Prototype</p>
      </header>
      
      <div id="roleSelection" class="text-center">
         <h2 class="text-2xl font-bold mb-4">Choose Your Role</h2>
         <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-8">
            <button id="teacherRoleBtn" class="w-full sm:w-64 px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition-colors duration-200">I'm a Teacher</button>
            <button id="studentRoleBtn" class="w-full sm:w-64 px-8 py-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl transition-colors duration-200">I'm a Student</button>
         </div>
      </div>
      
      <div id="teacherDashboard" class="hidden">
         <div id="status" class="text-center mb-6 text-sm font-medium text-slate-400">Disconnected.</div>
         <form id="createSessionForm" class="p-4 bg-slate-900 rounded-xl mb-6">
            <h2 class="text-xl font-bold mb-4">Create New Session</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="sessionName" class="block text-sm font-medium text-slate-400 mb-1">Session Name</label>
                    <input type="text" id="sessionName" placeholder="e.g., AI Fundamentals" class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg"/>
                </div>
                <div>
                    <label for="sessionFile" class="block text-sm font-medium text-slate-400 mb-1">Upload Presentation (.pdf)</label>
                    <input type="file" id="sessionFile" accept=".pdf" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                </div>
                <div>
                    <label for="sessionDate" class="block text-sm font-medium text-slate-400 mb-1">Date</label>
                    <input type="date" id="sessionDate" class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg"/>
                </div>
                <div>
                    <label for="sessionTime" class="block text-sm font-medium text-slate-400 mb-1">Time</label>
                    <input type="time" id="sessionTime" class="w-full px-4 py-2 bg-slate-700 text-white rounded-lg"/>
                </div>
            </div>
            <button type="button" id="createSessionBtn" class="w-full mt-4 px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg">Create & Schedule Session</button>
         </form>
         <div class="mb-4">
             <h2 class="text-2xl font-bold text-center">Scheduled Sessions</h2>
         </div>
         <div id="teacherSessionList" class="space-y-4"></div>
      </div>
      
      <div id="studentDashboard" class="hidden">
          <p id="studentStatus" class="text-center mb-6 text-sm font-medium text-slate-400">Disconnected.</p>
          <div class="p-4 bg-slate-900 rounded-xl mb-6 flex justify-between items-center">
              <h2 class="text-xl font-bold">Available Sessions</h2>
              <button id="refreshSessionsBtn" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors duration-200">Refresh</button>
          </div>
          <div id="sessionList" class="space-y-4">
              <p id="noSessionsMessage" class="text-center text-slate-500">No sessions found. Click refresh to check.</p>
          </div>
      </div>

      <div id="studentView" class="hidden text-center">
          <h2 class="text-xl font-bold my-4">Live Session: <span id="studentCurrentSessionId" class="text-emerald-400"></span></h2>
          <div class="slide-display" id="studentContentWrapper">
              <span>Waiting for teacher...</span>
          </div>
          <div id="studentChatContainer" class="hidden mt-4">
            <div id="studentChatMessages" class="h-40 overflow-auto p-3 bg-slate-900 rounded-lg text-sm text-slate-300 text-left"></div>
            <div class="mt-2 flex gap-2">
              <input id="studentChatInput" class="flex-1 px-4 py-2 bg-slate-800 rounded-lg focus:outline-none" placeholder="Type a message..." />
              <button id="studentSendChatBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg">Send</button>
            </div>
          </div>
      </div>
    </div>

    <script>
      // --- DOM Elements ---
      const roleSelectionEl = document.getElementById("roleSelection");
      const teacherRoleBtn = document.getElementById("teacherRoleBtn");
      const studentRoleBtn = document.getElementById("studentRoleBtn");
      const teacherDashboardEl = document.getElementById("teacherDashboard");
      const statusEl = document.getElementById("status");
      const createSessionFormEl = document.getElementById("createSessionForm");
      const sessionNameInput = document.getElementById("sessionName");
      const sessionFileInput = document.getElementById("sessionFile");
      const sessionDateInput = document.getElementById("sessionDate");
      const sessionTimeInput = document.getElementById("sessionTime");
      const createSessionBtn = document.getElementById("createSessionBtn");
      const teacherSessionListEl = document.getElementById("teacherSessionList");
      const studentDashboardEl = document.getElementById("studentDashboard");
      const studentStatusEl = document.getElementById("studentStatus");
      const refreshSessionsBtn = document.getElementById("refreshSessionsBtn");
      const sessionListEl = document.getElementById("sessionList");
      const noSessionsMessageEl = document.getElementById("noSessionsMessage");
      const studentViewEl = document.getElementById("studentView");
      const studentContentWrapper = document.getElementById("studentContentWrapper");
      const studentCurrentSessionIdEl = document.getElementById("studentCurrentSessionId");
      const studentChatContainer = document.getElementById("studentChatContainer");
      const studentChatMessages = document.getElementById("studentChatMessages");
      const studentChatInput = document.getElementById("studentChatInput");
      const studentSendChatBtn = document.getElementById("studentSendChatBtn");

      let ws;
      let currentSessionIdForStudent = null;

      // --- IndexedDB Management ---
      const dbManager = {
        db: null,
        init() {
            return new Promise((resolve, reject) => {
                if (this.db) return resolve();
                const request = indexedDB.open("slidesDB", 1);
                request.onerror = (event) => reject("IndexedDB error: " + event.target.errorCode);
                request.onsuccess = (event) => { this.db = event.target.result; resolve(); };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('slides')) {
                        db.createObjectStore('slides', { keyPath: 'id' });
                    }
                };
            });
        },
        async storeSlide(sessionId, slideNum, blob) {
            await this.init();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['slides'], 'readwrite');
                const request = transaction.objectStore('slides').put({ id: `${sessionId}-slide-${slideNum}`, image: blob });
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject('Failed to store slide: ' + event.target.error);
            });
        },
        async getSlide(sessionId, slideNum) {
            await this.init();
            return new Promise((resolve, reject) => {
                const request = this.db.transaction(['slides'], 'readonly').objectStore('slides').get(`${sessionId}-slide-${slideNum}`);
                request.onsuccess = (event) => {
                    if (event.target.result) resolve(event.target.result.image);
                    else reject('Slide not found in local storage.');
                };
                request.onerror = (event) => reject('Failed to get slide: ' + event.target.error);
            });
        },
        async isSessionDownloaded(sessionId, slideCount) {
             await this.init();
             if (slideCount === 0) return true;
             return new Promise((resolve) => {
                const request = this.db.transaction(['slides'], 'readonly').objectStore('slides').get(`${sessionId}-slide-${slideCount}`);
                request.onsuccess = (event) => resolve(!!event.target.result);
                request.onerror = () => resolve(false);
            });
        }
      };
      
      // --- UTILITY Functions ---
      const generateSessionId = () => Math.random().toString(36).substring(2, 8).toUpperCase();
      
      const updateTeacherSlideDisplayFromServer = (el, slide, sessionId) => {
        if (!sessionId || slide < 1) { el.innerHTML = `<span>Waiting...</span>`; return; }
        const imageURL = `http://localhost:8080/slides/${sessionId}/slide-${slide}.png`;
        el.innerHTML = `<img src="${imageURL}" alt="Slide ${slide}" onerror="this.onerror=null;this.innerHTML='<span>Image Not Found</span>';">`;
      };
      
      const updateStudentSlideDisplayFromLocal = async (el, slide, sessionId, slideCount) => {
        if (!sessionId || slide < 1 || (slideCount && slide > slideCount)) { el.innerHTML = `<span>Waiting...</span>`; return; }
        try {
            const imageBlob = await dbManager.getSlide(sessionId, slide);
            const objectURL = URL.createObjectURL(imageBlob);
            if (el.dataset.previousUrl) URL.revokeObjectURL(el.dataset.previousUrl);
            el.innerHTML = `<div id="studentSlideDisplay"><img src="${objectURL}" alt="Slide ${slide}"></div>`;
            el.dataset.previousUrl = objectURL;
        } catch (error) { el.innerHTML = `<span>Slide not loaded.</span>`; }
      };

      const escapeHtml = (s) => (s + "").replace(/[&<>"'`]/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;", "`": "&#96;" }[m]));
      
      const appendChatMessageToBox = (chatBox, message) => {
        const when = new Date(message.timestamp || Date.now()).toLocaleTimeString();
        const role = message.senderRole || message.role || "unknown";
        const el = document.createElement("div");
        el.className = "mb-2";
        el.innerHTML = `<span class="text-xs text-slate-400">[${when}]</span> <strong class="text-sm ml-1">${role}:</strong> <span class="ml-2 text-sm">${escapeHtml(message.text)}</span>`;
        chatBox.appendChild(el);
        chatBox.scrollTop = chatBox.scrollHeight;
      };
      
      // --- INITIAL ROLE SELECTION & CONNECTION ---
      teacherRoleBtn.addEventListener("click", () => {
          roleSelectionEl.classList.add("hidden");
          teacherDashboardEl.classList.remove("hidden");
          ws = new WebSocket("ws://localhost:8080");
          ws.onopen = () => { statusEl.textContent = "Connected."; statusEl.classList.add("text-green-400"); };
          ws.onclose = () => { statusEl.textContent = "Disconnected."; statusEl.classList.remove("text-green-400"); };
          ws.onmessage = (event) => {
             try {
                const message = JSON.parse(event.data);
                if (message.action === "chatMessage" && message.sessionId) {
                  const card = document.querySelector(`.session-card[data-session-id="${message.sessionId}"]`);
                  if (card) {
                    const chatBox = card.querySelector(".chat-messages");
                    if (chatBox) appendChatMessageToBox(chatBox, message);
                  }
                }
                if (message.action === "whiteboardClear" && message.sessionId) {
                    const card = document.querySelector(`.session-card[data-session-id="${message.sessionId}"]`);
                    const canvas = card?.querySelector(".wb-canvas");
                    if(canvas) canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
                }
                if (message.action === "whiteboardStroke" && message.sessionId) {
                    const card = document.querySelector(`.session-card[data-session-id="${message.sessionId}"]`);
                    const canvas = card?.querySelector(".wb-canvas");
                    if(canvas) drawStrokeOnCanvas(canvas, message.stroke);
                }
             } catch(e) { console.error("Teacher WS message error:", e)}
          };
      });

      studentRoleBtn.addEventListener("click", () => {
          roleSelectionEl.classList.add("hidden");
          studentDashboardEl.classList.remove("hidden");
          studentStatusEl.textContent = "Click Refresh to see available sessions.";
          dbManager.init();
      });

      // --- TEACHER LOGIC ---
      createSessionBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        if (!ws || ws.readyState !== WebSocket.OPEN) { statusEl.textContent = "Not connected."; return; }
        const sessionName = sessionNameInput.value.trim();
        const sessionFile = sessionFileInput.files[0];
        const sessionDate = sessionDateInput.value;
        const sessionTime = sessionTimeInput.value;
        if (!sessionName || !sessionFile || !sessionDate || !sessionTime) { statusEl.textContent = "Please fill all fields."; return; }
        
        statusEl.textContent = "Uploading...";
        const sessionId = generateSessionId();
        const formData = new FormData();
        formData.append("sessionFile", sessionFile);
        formData.append("sessionId", sessionId);

        try {
          const response = await fetch("http://localhost:8080/upload", { method: "POST", body: formData });
          const result = await response.json();
          if (!response.ok || !result.success) throw new Error(result.message || "File upload failed.");

          const { slideCount } = result;
          ws.send(JSON.stringify({
            action: "createSession", sessionId, sessionName, sessionDate, sessionTime,
            pptFileNames: [sessionFile.name], slideCount, role: "teacher"
          }));
          addSessionCardToTeacherList(sessionId, sessionName, [sessionFile.name], slideCount, sessionDate, sessionTime);
          createSessionFormEl.reset();
          statusEl.textContent = "Session created!";
        } catch (error) { statusEl.textContent = `Error: ${error.message}`; }
      });

      const addSessionCardToTeacherList = (sessionId, name, files, slideCount, date, time) => {
        const card = document.createElement("div");
        card.className = "session-card bg-slate-900 rounded-xl p-6 shadow-md border border-indigo-500";
        card.dataset.sessionId = sessionId;
        card.dataset.sessionName = name;
        card.dataset.slideCount = slideCount;
        card.innerHTML = `
          <h3 class="text-xl font-bold mb-2 text-indigo-400">Session: ${name} (${sessionId})</h3>
          <p class="text-sm text-slate-400">Scheduled for: ${date} at ${time}</p>
          <p class="text-sm text-slate-400 mb-4">Files: ${files.join(', ')} (${slideCount} slides)</p>
          <button class="start-session-btn w-full mb-4 px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg">Start Session</button>
          <div class="teacher-view hidden text-center">
            <div class="slide-display mb-4"><span>Presentation will appear here.</span></div>
            <div class="whiteboard-container hidden mt-4">
                 <div class="slide-display" style="height:400px;">
                    <canvas class="wb-canvas"></canvas>
                 </div>
                 <div class="mt-3 flex gap-2 justify-center">
                    <button class="clear-whiteboard-btn px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg">Clear</button>
                 </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4">
                <button class="prev-btn px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">&larr; Prev</button>
                <button class="next-btn px-6 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg">Next &rarr;</button>
                <button class="whiteboard-toggle-btn px-6 py-2 bg-amber-600 hover:bg-amber-700 rounded-lg">Toggle Whiteboard</button>
            </div>
            <div class="chat-container mt-4 text-left">
              <div class="chat-messages h-40 overflow-auto p-3 bg-slate-800 rounded-lg text-sm"></div>
              <div class="mt-2 flex gap-2">
                <input class="chat-input flex-1 px-4 py-2 bg-slate-700 rounded-lg" placeholder="Type..." />
                <button class="send-chat-btn px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg">Send</button>
              </div>
            </div>
          </div>`;
        teacherSessionListEl.appendChild(card);
      };

      function handleLocalWhiteboardToggleUI(card, enabled) {
        const wbContainer = card.querySelector(".whiteboard-container");
        const slideDisp = card.querySelector(".slide-display");
        const prevBtn = card.querySelector(".prev-btn");
        const nextBtn = card.querySelector(".next-btn");
        
        wbContainer.classList.toggle("hidden", !enabled);
        slideDisp.classList.toggle("hidden", enabled);
        if(prevBtn) prevBtn.disabled = enabled;
        if(nextBtn) nextBtn.disabled = enabled;
      }

      teacherSessionListEl.addEventListener("click", (e) => {
        const card = e.target.closest(".session-card");
        if (!card) return;
        const sessionId = card.dataset.sessionId;
        const slideCount = parseInt(card.dataset.slideCount);
        let slide = parseInt(card.dataset.slide || "1");

        if (e.target.matches(".start-session-btn")) {
            ws.send(JSON.stringify({ action: "startSession", role: "teacher", sessionId }));
            e.target.classList.add("hidden");
            card.querySelector(".teacher-view").classList.remove("hidden");
            updateTeacherSlideDisplayFromServer(card.querySelector(".slide-display"), slide, sessionId);
        }
        
        const changeSlide = (newSlide) => {
            card.dataset.slide = newSlide;
            ws.send(JSON.stringify({ action: "slideChange", role: "teacher", sessionId, slide: newSlide }));
            updateTeacherSlideDisplayFromServer(card.querySelector(".slide-display"), newSlide, sessionId);
        };
        if (e.target.matches(".next-btn")) changeSlide(Math.min(slide + 1, slideCount));
        if (e.target.matches(".prev-btn")) changeSlide(Math.max(slide - 1, 1));

        if (e.target.matches(".send-chat-btn")) {
            const input = card.querySelector(".chat-input");
            const text = input.value.trim();
            if (!text) return;
            const msg = { action: "chatMessage", sessionId, role: "teacher", text };
            ws.send(JSON.stringify(msg));
            appendChatMessageToBox(card.querySelector('.chat-messages'), { ...msg, senderRole: 'teacher', timestamp: Date.now() });
            input.value = "";
        }

        if (e.target.matches(".whiteboard-toggle-btn")) {
            const wbContainer = card.querySelector(".whiteboard-container");
            const isWbActive = !wbContainer.classList.contains("hidden");
            const enableWb = !isWbActive;
            ws.send(JSON.stringify({ action: "whiteboardToggle", role: "teacher", sessionId, enabled: enableWb }));
            handleLocalWhiteboardToggleUI(card, enableWb);
            if (enableWb) {
                const canvas = card.querySelector(".wb-canvas");
                // âœ… FIX: Directly clear the teacher's own canvas for immediate feedback.
                if (canvas) {
                    canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
                }
                attachWhiteboardHandlers(canvas, sessionId);
            }
        }
        
        if (e.target.matches(".clear-whiteboard-btn")) {
            const canvas = card.querySelector(".wb-canvas");
            if (canvas) {
                canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
                ws.send(JSON.stringify({ action: "whiteboardClear", role: "teacher", sessionId }));
            }
        }
      });

      // --- Whiteboard Drawing Logic ---
      function attachWhiteboardHandlers(canvas, sessionId) {
        if (!canvas || canvas._wbAttached) return;
        canvas._wbAttached = true;
        
        const dpr = window.devicePixelRatio || 1;
        canvas.width = canvas.clientWidth * dpr;
        canvas.height = canvas.clientHeight * dpr;

        const ctx = canvas.getContext("2d");
        ctx.lineCap = "round";
        ctx.strokeStyle = "#FFFFFF";
        ctx.lineWidth = 2 * dpr;
        let drawing = false;
        let currentStroke = [];

        const startStroke = (e) => {
            e.preventDefault(); drawing = true; currentStroke = [];
            const { x, y } = getPoint(e, canvas);
            currentStroke.push([x, y]);
        };
        const drawStroke = (e) => {
            if (!drawing) return; e.preventDefault();
            const { x, y } = getPoint(e, canvas);
            currentStroke.push([x, y]);
            drawStrokeOnCanvas(canvas, { points: currentStroke, color: '#FFFFFF', width: 2 });
        };
        const endStroke = () => {
            if (!drawing) return; drawing = false;
            if (currentStroke.length > 1) {
                ws.send(JSON.stringify({ action: "whiteboardStroke", role: "teacher", sessionId, stroke: { points: currentStroke, color: '#FFFFFF', width: 2 } }));
            }
        };
        const getPoint = (e, canvas) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - rect.left) / rect.width, y: (clientY - rect.top) / rect.height };
        };

        canvas.addEventListener("pointerdown", startStroke);
        canvas.addEventListener("pointermove", drawStroke);
        canvas.addEventListener("pointerup", endStroke);
        canvas.addEventListener("pointerleave", endStroke);
      }

      function drawStrokeOnCanvas(canvas, stroke) {
        if (!canvas || !stroke || !stroke.points || stroke.points.length < 2) return;
        const ctx = canvas.getContext("2d");
        const dpr = window.devicePixelRatio || 1;
        ctx.strokeStyle = stroke.color || "#FFFFFF";
        ctx.lineWidth = (stroke.width || 2) * dpr;
        ctx.beginPath();
        const pts = stroke.points;
        ctx.moveTo(pts[0][0] * canvas.width, pts[0][1] * canvas.height);
        for (let i = 1; i < pts.length; i++) {
            ctx.lineTo(pts[i][0] * canvas.width, pts[i][1] * canvas.height);
        }
        ctx.stroke();
      }

      // --- STUDENT LOGIC ---
      refreshSessionsBtn.addEventListener("click", () => {
          const listWs = new WebSocket("ws://localhost:8080?role=getSessions");
          studentStatusEl.textContent = "Refreshing session list...";
          listWs.onmessage = (event) => {
              const message = JSON.parse(event.data);
              if (message.action === "sessionList") {
                  renderSessionCards(message.sessions);
                  studentStatusEl.textContent = "Session list updated.";
              }
          };
      });

      const renderSessionCards = (sessions) => {
          sessionListEl.innerHTML = "";
          const sessionEntries = Object.entries(sessions);
          if (sessionEntries.length === 0) { noSessionsMessageEl.classList.remove("hidden"); return; }
          noSessionsMessageEl.classList.add("hidden");
          sessionEntries.forEach(async ([sessionId, session]) => {
              const card = document.createElement("div");
              card.className = `session-card bg-slate-900 rounded-xl p-4 shadow-md border ${session.status === "live" ? "border-emerald-500" : "border-slate-600"} flex flex-col sm:flex-row items-start justify-between gap-4`;
              const isDownloaded = await dbManager.isSessionDownloaded(sessionId, session.slideCount);
              card.innerHTML = `
                <div class="flex-grow">
                    <h3 class="text-lg font-bold ${session.status === "live" ? "text-emerald-400" : "text-slate-200"}">${session.sessionName}</h3>
                    <p class="text-sm text-slate-400">ID: ${sessionId}</p>
                    <p class="text-sm text-slate-500 mt-2">Files: ${session.pptFileNames.join(', ')} (${session.slideCount} slides)</p>
                </div>
                <div class="flex flex-col items-end gap-2 w-full sm:w-auto">
                    <div class="w-full text-right h-4"><span class="download-status text-xs text-slate-400"></span></div>
                    <button class="download-btn w-full px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white font-bold rounded-lg ${isDownloaded ? 'hidden' : ''}" data-session-id="${sessionId}" data-slide-count="${session.slideCount}">Download Materials</button>
                    ${session.status === 'live'
                        ? `<button class="join-session-btn w-full px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg disabled:bg-slate-600" data-session-id="${sessionId}" ${!isDownloaded ? 'disabled' : ''}>Join</button>`
                        : `<div class="w-full px-4 py-2 bg-slate-700 text-slate-400 font-bold rounded-lg text-center">Scheduled ${isDownloaded ? '(Downloaded)' : ''}</div>`
                    }
                </div>`;
              sessionListEl.appendChild(card);
          });
      };

      sessionListEl.addEventListener('click', (e) => {
          if (e.target.matches('.download-btn')) {
              const button = e.target;
              downloadSession(button.dataset.sessionId, parseInt(button.dataset.slideCount), button);
          }
          if (e.target.matches('.join-session-btn')) {
              joinSession(e.target.dataset.sessionId);
          }
      });
      
      async function downloadSession(sessionId, slideCount, button) {
          const card = button.closest('.session-card');
          const statusEl = card.querySelector('.download-status');
          const joinBtn = card.querySelector('.join-session-btn');
          button.disabled = true;
          statusEl.textContent = 'Downloading...';
          let downloadedCount = 0;
          for (let i = 1; i <= slideCount; i++) {
              try {
                  const response = await fetch(`http://localhost:8080/slides/${sessionId}/slide-${i}.png`);
                  const blob = await response.blob();
                  await dbManager.storeSlide(sessionId, i, blob);
                  downloadedCount++;
                  statusEl.textContent = `Downloading... (${downloadedCount}/${slideCount})`;
              } catch (error) { statusEl.textContent = `Error downloading.`; button.disabled = false; return; }
          }
          statusEl.textContent = 'Complete!';
          button.classList.add('hidden');
          if (joinBtn) joinBtn.disabled = false;
          const scheduledDiv = card.querySelector('.bg-slate-700');
          if (scheduledDiv) scheduledDiv.textContent = 'Scheduled (Downloaded)';
      }

      const joinSession = (sessionId) => {
        studentDashboardEl.classList.add("hidden");
        studentViewEl.classList.remove("hidden");
        studentCurrentSessionIdEl.textContent = sessionId;
        currentSessionIdForStudent = sessionId;
        studentChatContainer.classList.remove("hidden");
        studentChatMessages.innerHTML = "";
        
        if (ws && ws.readyState === WebSocket.OPEN) { ws.close(); }
        ws = new WebSocket(`ws://localhost:8080?sessionId=${sessionId}&role=student`);
        ws.onopen = () => ws.send(JSON.stringify({ action: "getInitialState" }));
        
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.action === "slideChange") {
                updateStudentSlideDisplayFromLocal(studentContentWrapper, msg.slide, currentSessionIdForStudent, msg.slideCount);
            }
            if (msg.action === "chatMessage") {
                appendChatMessageToBox(studentChatMessages, msg);
            }
            if (msg.action === "whiteboardToggle") {
                if (msg.enabled) {
                    const canvas = document.createElement('canvas');
                    canvas.className = 'wb-canvas';
                    studentContentWrapper.innerHTML = '';
                    studentContentWrapper.appendChild(canvas);
                    const dpr = window.devicePixelRatio || 1;
                    canvas.width = canvas.clientWidth * dpr;
                    canvas.height = canvas.clientHeight * dpr;
                } else {
                    updateStudentSlideDisplayFromLocal(studentContentWrapper, msg.slide, currentSessionIdForStudent, msg.slideCount);
                }
            }
            if (msg.action === "whiteboardState" && Array.isArray(msg.strokes)) {
                const canvas = studentContentWrapper.querySelector(".wb-canvas");
                if (canvas) msg.strokes.forEach(stroke => drawStrokeOnCanvas(canvas, stroke));
            }
            if (msg.action === "whiteboardStroke") {
                const canvas = studentContentWrapper.querySelector(".wb-canvas");
                if (canvas) drawStrokeOnCanvas(canvas, msg.stroke);
            }
            if (msg.action === "whiteboardClear") {
                const canvas = studentContentWrapper.querySelector(".wb-canvas");
                if (canvas) canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
            }
        };
        ws.onclose = () => {
            studentDashboardEl.classList.remove("hidden");
            studentViewEl.classList.add("hidden");
            studentStatusEl.textContent = "Disconnected from session.";
        };
      };

      studentSendChatBtn.addEventListener("click", () => {
        const text = studentChatInput.value.trim();
        if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
        ws.send(JSON.stringify({ action: "chatMessage", role: "student", sessionId: currentSessionIdForStudent, text }));
        studentChatInput.value = "";
      });
    </script>
  </body>
</html>

